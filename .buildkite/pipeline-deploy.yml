steps:
  - label: "Build & Push"
    agents:
      queue: kubernetes
    plugins:
      - kubernetes:
          podSpec:
            containers:
              - name: kaniko
                image: gcr.io/kaniko-project/executor:latest
                args: ["--dockerfile=/workspace/build/buildkite/bassmatt/magic512bot/Dockerfile",
                        "--context=dir://workspace/build/buildkite/bassmatt/magic512bot",
                        "--destination=bassmatt/magic512bot"] # replace with your dockerhub account
                volumeMounts:
                  - name: kaniko-secret
                    mountPath: /kaniko/.docker
                  - name: dockerfile-storage
                    mountPath: /workspace
            restartPolicy: Never
            volumes:
              - name: kaniko-secret
                secret:
                  secretName: regcred
                  items:
                    - key: .dockerconfigjson
                      path: config.json
              - name: dockerfile-storage
                persistentVolumeClaim:
                  claimName: dockerfile-claim
  - wait
  - label: "Deploy to Kubernetes"
    command: .buildkite/buildkite-deploy
    concurrency: 1
    concurrency_group: deploy/prod
    agents:
      queue: kubernetes
