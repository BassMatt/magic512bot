#!/usr/bin/env sh

set -euo pipefail

# envsubst needed for enforcing manifest
apt-get update && apt-get install -y --no-install-recommends gettext-base

export DOCKER_IMAGE="bassmatt/magic512bot:${BUILDKITE_BUILD_NUMBER}"

manifest="$(mktemp)"

echo '--- :kubernetes: Shipping'

envsubst < deployment.yml > "${manifest}"
kubectl apply -f "${manifest}"

echo '--- :zzz: Waiting for deployment'
kubectl wait --for condition=available --timeout=300s -f "${manifest}"
